#!/bin/sh

# Color variables for output formatting
RED='\033[31m'
GREEN='\033[32m'
YELLOW='\033[33m'
BLUE='\033[34m'
MAGENTA='\033[35m'
CYAN='\033[36m'
WHITE='\033[37m'
GRAY='\033[90m'
BLACK='\033[0m'

# Constants
DEFAULT_PORT=3000
DOCKER_STOP_TIMEOUT=0

# Global variables
PROJECT_NAME=$(basename "$PWD")

# Determine container name and image based on presence of local Dockerfile.devbox
if [ -f "Dockerfile.devbox" ]; then
  CONTAINER_NAME="devbox-$PROJECT_NAME"
  IMAGE_NAME="devbox-$PROJECT_NAME"
else
  CONTAINER_NAME="$PROJECT_NAME"
  IMAGE_NAME="devbox"
fi

# Core utility functions
get_script_directory() {
  local script_path="$0"
  while [ -L "$script_path" ]; do
    script_path="$(readlink "$script_path")"
  done
  cd "$(dirname "$script_path")" && pwd
}

container_exists() {
  docker ps -a --format '{{.Names}}' | grep -q "^$CONTAINER_NAME$"
}

container_is_running() {
  [ "$(docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null)" = "true" ]
}

image_exists() {
  docker image inspect "$IMAGE_NAME" >/dev/null 2>&1
}

print_error() {
  echo "${RED}Error: $1${BLACK}"
}

print_success() {
  echo "âœ… $1"
}

# Function to check prerequisites
check_prerequisites() {
  # Check if docker command exists
  if ! command -v docker >/dev/null 2>&1; then
    print_error "Docker is not installed."
    echo "Please install Docker: brew install docker"
    return 1
  fi

  # Check if orb command exists (for OrbStack)
  if ! command -v orb >/dev/null 2>&1; then
    print_error "OrbStack is not installed."
    echo "Please install OrbStack: brew install orbstack"
    return 1
  fi

  # Check if OrbStack is running
  if ! orb status >/dev/null 2>&1; then
    echo "OrbStack is not running. Starting OrbStack..."
    orb start
    print_success "OrbStack started successfully."
  fi

  # Check if Docker daemon is accessible
  if ! docker info >/dev/null 2>&1; then
    print_error "Docker daemon is not accessible."
    echo "Please ensure Docker/OrbStack is running properly."
    return 1
  fi

  return 0
}


# Function to get the hash of the Dockerfile content
get_dockerfile_hash() {
  local dockerfile_path="$1"
  if [ -f "$dockerfile_path" ]; then
    shasum -a 256 "$dockerfile_path" | cut -d' ' -f1
  else
    echo ""
  fi
}

# Function to get the stored hash for the image
get_image_dockerfile_hash() {
  docker image inspect "$IMAGE_NAME" --format '{{index .Config.Labels "dockerfile.hash"}}' 2>/dev/null || echo ""
}

# Docker operation functions
create_container() {
  local port="${PORT:-$DEFAULT_PORT}"
  echo "Creating new container $CONTAINER_NAME..."
  docker run -d -p "$port:$port" -e "PORT=$port" --name "$CONTAINER_NAME" \
    -v "$PWD":/"$PROJECT_NAME" "$IMAGE_NAME" tail -f /dev/null
}

start_container() {
  if container_exists; then
    if ! container_is_running; then
      echo "Starting stopped container $CONTAINER_NAME..."
      docker start "$CONTAINER_NAME"
    else
      echo "Container $CONTAINER_NAME is already running."
    fi
  else
    create_container
  fi
}

stop_container() {
  if container_exists; then
    echo "Stopping and deleting container $CONTAINER_NAME..."
    docker stop -t "$DOCKER_STOP_TIMEOUT" "$CONTAINER_NAME" 2>/dev/null || true
    docker rm "$CONTAINER_NAME"
  else
    echo "Container $CONTAINER_NAME does not exist."
  fi
}

# Function to check if image needs rebuilding
needs_rebuild() {
  local dockerfile_path
  if [ -f "Dockerfile.devbox" ]; then
    dockerfile_path="$PWD/Dockerfile.devbox"
  else
    dockerfile_path="$(get_script_directory)/Dockerfile.devbox"
  fi

  # Check if image exists
  if ! image_exists; then
    return 0  # Image doesn't exist, needs build
  fi

  # Get current Dockerfile hash and stored hash
  local current_hash stored_hash
  current_hash=$(get_dockerfile_hash "$dockerfile_path")
  stored_hash=$(get_image_dockerfile_hash)

  # If we can't get hashes or they don't match, rebuild needed
  if [ -z "$current_hash" ] || [ -z "$stored_hash" ] || [ "$current_hash" != "$stored_hash" ]; then
    return 0  # Dockerfile content has changed, needs rebuild
  fi

  return 1  # No rebuild needed
}

# Function to build the Docker image
build_image() {
  local dockerfile_path
  if [ -f "Dockerfile.devbox" ]; then
    dockerfile_path="$PWD/Dockerfile.devbox"
  else
    dockerfile_path="$(get_script_directory)/Dockerfile.devbox"
  fi

  if [ ! -f "$dockerfile_path" ]; then
    print_error "Dockerfile not found at $dockerfile_path"
    return 1
  fi

  # Get Dockerfile hash to store as label
  local dockerfile_hash
  dockerfile_hash=$(get_dockerfile_hash "$dockerfile_path")

  echo "Building Docker image '$IMAGE_NAME'..."
  if [ -f "Dockerfile.devbox" ]; then
    # Project-specific build from current directory
    if ! docker build -f "Dockerfile.devbox" -t "$IMAGE_NAME" --label "dockerfile.hash=$dockerfile_hash" .; then
      print_error "Failed to build Docker image."
      return 1
    fi
  else
    # Default build from devbox repo directory
    local script_dir
    script_dir=$(get_script_directory)
    if ! docker build -f "$script_dir/Dockerfile.devbox" -t "$IMAGE_NAME" --label "dockerfile.hash=$dockerfile_hash" "$script_dir"; then
      print_error "Failed to build Docker image."
      return 1
    fi
  fi

  print_success "Successfully built $IMAGE_NAME image."
  return 0
}

# Function to check if Dockerfile exists and image is built/current
check_dockerfile_and_image() {
  if [ -f "Dockerfile.devbox" ]; then
    # Project-specific container: local Dockerfile exists
    :  # no-op, file exists
  else
    # Default container: check for devbox Dockerfile in script directory
    local dockerfile_path
    dockerfile_path="$(get_script_directory)/Dockerfile.devbox"
    if [ ! -f "$dockerfile_path" ]; then
      print_error "Default Dockerfile.devbox not found at $dockerfile_path"
      echo "Please ensure devbox is properly installed."
      return 1
    fi
  fi

  # Check if image exists and is current
  if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
    echo "Docker image '$IMAGE_NAME' not found. Building image..."
    build_image
  elif needs_rebuild; then
    echo "Dockerfile has been modified. Rebuilding image..."
    build_image
  fi

  return 0
}


# Function to attach to the devbox container
attach_devbox() {
  # Check prerequisites and dockerfile/image before attaching
  if ! check_prerequisites; then
    return 1
  fi

  if ! check_dockerfile_and_image; then
    return 1
  fi

  # Start container (create if needed)
  start_container

  # Attach to the container
  docker exec -it -w "/$PROJECT_NAME" "$CONTAINER_NAME" /bin/zsh
}

# Function to initialize a new devbox project
init_devbox() {
  if [ -f "Dockerfile.devbox" ]; then
    echo "Dockerfile.devbox already exists in current directory."
    echo "Remove it first if you want to reinitialize."
    return 1
  fi

  local script_dir template_path
  script_dir=$(get_script_directory)
  template_path="$script_dir/Dockerfile.devbox"

  if [ -f "$template_path" ]; then
    cp "$template_path" "./Dockerfile.devbox"
    echo "Created Dockerfile.devbox from template in current directory."
    echo "Edit the Dockerfile.devbox to customize tools for your project."
    echo "This project will now use container: devbox-$PROJECT_NAME"
  else
    print_error "Dockerfile.devbox not found in devbox installation directory."
    echo "Please ensure devbox is properly installed."
    return 1
  fi
}


# Function to show status of the devbox image and container
show_status() {
  local dockerfile_path
  if [ -f "Dockerfile.devbox" ]; then
    dockerfile_path="$PWD/Dockerfile.devbox"
  else
    dockerfile_path="$(get_script_directory)/Dockerfile.devbox"
  fi

  echo "$PROJECT_NAME"
  printf "  Dockerfile: %s\n" "$dockerfile_path"

  # Check if image exists and determine status
  if ! image_exists; then
    printf "  Image:       %s " "$IMAGE_NAME"
    printf "${YELLOW}[NOT BUILT]${BLACK}\n"
  else
    printf "  Image:       %s " "$IMAGE_NAME"
    # Check if rebuild is needed
    if needs_rebuild; then
      printf "${YELLOW}[REBUILD NEEDED]${BLACK}\n"
    else
      printf "${GREEN}[UP TO DATE]${BLACK}\n"
    fi
  fi

  # Check container status
  printf "  Container:   %s " "$CONTAINER_NAME"
  if container_exists; then
    if container_is_running; then
      printf "${GREEN}[RUNNING]${BLACK}\n"
    else
      printf "${YELLOW}[STOPPED]${BLACK}\n"
    fi
  else
    printf "${YELLOW}[NOT CREATED]${BLACK}\n"
  fi
}

# Function to build/rebuild the devbox image
build_devbox() {
  if ! check_prerequisites; then
    return 1
  fi

  local dockerfile_path
  if [ -f "Dockerfile.devbox" ]; then
    dockerfile_path="$PWD/Dockerfile.devbox"
  else
    dockerfile_path="$(get_script_directory)/Dockerfile.devbox"
  fi

  if [ ! -f "$dockerfile_path" ]; then
    print_error "Dockerfile not found at $dockerfile_path"
    if [ ! -f "Dockerfile.devbox" ]; then
      echo "Run 'devbox init' to create a project-specific Dockerfile.devbox"
    fi
    return 1
  fi

  build_image
}

# Function to delete the devbox image
delete_devbox() {
  if ! check_prerequisites; then
    return 1
  fi

  # Stop and delete the container if it exists
  if container_exists; then
    echo "Stopping and deleting container $CONTAINER_NAME..."
    docker stop -t "$DOCKER_STOP_TIMEOUT" "$CONTAINER_NAME" 2>/dev/null || true
    docker rm "$CONTAINER_NAME" 2>/dev/null || true
  fi

  # Delete the image if it exists
  if image_exists; then
    echo "Deleting Docker image '$IMAGE_NAME'..."
    if docker rmi "$IMAGE_NAME" 2>/dev/null; then
      print_success "Successfully deleted image '$IMAGE_NAME'"
    else
      print_error "Failed to delete image '$IMAGE_NAME'"
      return 1
    fi
  else
    echo "Docker image '$IMAGE_NAME' does not exist."
  fi
}

# Check the command argument
case "$1" in
  init)
    init_devbox
    ;;
  status)
    show_status
    ;;
  build)
    build_devbox
    ;;
  delete)
    delete_devbox
    ;;
  start)
    # Explicitly start container (existing functionality)
    if ! check_prerequisites; then
      exit 1
    fi

    if ! check_dockerfile_and_image; then
      exit 1
    fi

    start_container
    ;;
  stop)
    stop_container
    ;;
  "")
    attach_devbox
    ;;
  help|--help|-h|*)
    echo "Usage: $0 [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  (no args)  - Create the devbox and attach to it."
    echo "  status     - Show status of devbox Dockerfile, image, and container."
    echo "  init       - Copy Dockerfile.devbox template to current directory for a project-specific devbox."
    echo "  build      - Build/rebuild the devbox Docker image"
    echo "  delete     - Stop the container, delete it, and delete the image."
    echo "  start      - Start the container."
    echo "  stop       - Stop the container and delete the container."
    ;;
esac
